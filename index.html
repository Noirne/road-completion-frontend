<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Road completion project - overview</title>    
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>
    <style>
        #features {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 300px;
            overflow: auto;
            background: rgba(255, 255, 255, 0.8);
        }
        #map canvas {
            cursor: crosshair;
        }
    </style>

<div id='map'></div>
<pre id='features'></pre>
<script>
    mapboxgl.accessToken = 'pk.eyJ1Ijoiam9vc3RzY2hvdXBwZSIsImEiOiJjaWh2djF1c2owMmJrdDNtMWV2c2Rld3QwIn0.9zXJJWZ4rOcspyFIdEC3Rw';
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: {
            "version": 8,
            "name": "Mapbox Streets",
            "sprite": "mapbox://sprites/mapbox/streets-v8",
            "glyphs": "mapbox://fonts/mapbox/{fontstack}/{range}.pbf",
            "sources": {
                "agiv": {
                    type: "raster",
                    tiles: [
                        "http://tile.informatievlaanderen.be/ws/raadpleegdiensten/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=omwrgbmrvl&STYLE=&FORMAT=image/png&tileMatrixSet=GoogleMapsVL&tileMatrix={z}&tileRow={y}&tileCol={x}"
                    ],
                    tileSize: 256
                }
            },
            "layers": [
                {
                    "id":"background",
                    "type":"background",
                    "paint":{
                        "background-color":"rgb(4,7,14)"
                    }
                },
                {
                    "id":"satellite",
                    "type":"raster",
                    "source":"agiv",
                    "source-layer":"mapbox_satellite_full"
                }
            ]
        },
        // style: 'mapbox://styles/mapbox/satellite-v9',
        // style: 'mapbox://styles/xivk/cjdd899nbbm7y2spdd9xq6xil', // stylesheet location
        center: [4.4629, 51.0671], // starting position [lng, lat]
        zoom: 9, // starting zoom
        hash: true
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    map.on("load", function() {
        var layers = map.getStyle().layers;
        // Find the index of the first symbol layer in the map style
        var firstSymbolId;
        for (var i = 0; i < layers.length; i++) {
            if (layers[i].id.includes("road")) {
                firstSymbolId = layers[i].id;
                break;
            }
        }

        // replace road tiles with road tiles for this instance.
        map.addSource("buffers", {
            "type": "vector",
            "tiles": [
                "http://roads-tiles.osm.be/data/buffers/{z}/{x}/{y}.pbf"
            ],
            "maxzoom": 14
        });
        map.addSource("diffs", {
            "type": "vector",
            "tiles": [
                "http://roads-tiles.osm.be/data/diffs/{z}/{x}/{y}.pbf"
            ],
            "maxzoom": 14
        });
        // map.addSource("refs", {
        //     "type": "vector",
        //     "tiles": [
        //         "http://roads-tiles.osm.be/data/refs/{z}/{x}/{y}.pbf"
        //     ],
        //     "maxzoom": 14
        // });

        map.addLayer({
            "id": "buffers",
            "source": "buffers",
            "source-layer": "buffers",
            "type": "fill",
            "paint": {
                "fill-color": "#FFFFFF",
                "fill-opacity": 0.2
            },
            "minzoom": 14
        }, firstSymbolId);

        map.addLayer({
            "id": "diffs-details",
            "source": "diffs",
            "source-layer": "diffs",
            "type": "line",
            "paint": {
                "line-color": "#FFFF00",
                "line-width": 10,
                "line-opacity": 0.2
            },
            "minzoom": 16
        });

        map.addLayer({
            "id": "diffs",
            "source": "diffs",
            "source-layer": "diffs",
            "type": "line",
            "paint": {
                "line-color": "#FFFF00",
                "line-width": 2
            },
            "maxzoom": 16
        });

        map.addLayer({
            "id": "diffs-details-hover",
            "source": "diffs",
            "source-layer": "diffs",
            "type": "line",
            "paint": {
                "line-color": "#FFFF00",
                "line-width": 15,
                "line-opacity": 0.5
            },
            "filter": ["==", "id", ""],
            "minzoom": 16
        });

        map.addLayer({
            "id": "diffs-hover",
            "type": "line",
            "source": "diffs",
            "source-layer": "diffs",
            "paint": {
                "line-color": "#FFFF00",
                "line-width": 6
            },
            "filter": ["==", "id", ""],
            "maxzoom": 16
        });
    });

    var selectedFeature = "";

    map.on('click', function (e) {
        // reset currently selected feature.
        if (selectedFeature) {
            map.setFilter("diffs-hover", ["==", "id", ""]);
            map.setFilter("diffs-details-hover", ["==", "id", ""]);
            selectedFeature = "";
        }
        
        // search in small box around click location.
        var point = e.point;
        var width = 10;
        var height = 20;
        var features = map.queryRenderedFeatures([
            [point.x - width / 2, point.y - height / 2],
            [point.x + width / 2, point.y + height / 2]],
            { layers: ["diffs", "diffs-details"] });
            
        if (features && features[0] && features[0].properties && features[0].properties.id) {
            selectedFeature = features[0].properties.id;
            
            map.setFilter("diffs-hover", ["==", "id", selectedFeature]);
            map.setFilter("diffs-details-hover", ["==", "id", selectedFeature]);

            document.getElementById('features').innerHTML = JSON.stringify(features[0], null, 2);
        }

        if (!selectedFeature) {
            document.getElementById('features').innerHTML = "";
        }
    });

</script>

</body>
</html>